<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="Create a dataset of duplicates derived from matching names, email addresses, postal addresses, and phone numbers. The match probability
for each probable duplicate is determined using the fastLink package."><title>duplicates_stream — duplicates_stream • tessistream</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="duplicates_stream — duplicates_stream"><meta property="og:description" content="Create a dataset of duplicates derived from matching names, email addresses, postal addresses, and phone numbers. The match probability
for each probable duplicate is determined using the fastLink package."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">tessistream</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-developer">Developer</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-developer">
    <a class="dropdown-item" href="../../dataAtBAM/index.html">data @ BAM</a>
    <a class="dropdown-item" href="../../tessireport/index.html">tessireport</a>
    <a class="dropdown-item" href="../../tessistream/index.html">tessistream</a>
    <a class="dropdown-item" href="../../tessilake/index.html">tessilake</a>
    <a class="dropdown-item" href="../../tessiflow/index.html">tessiflow</a>
  </div>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"></ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>duplicates_stream</h1>
      
      <div class="d-none name"><code>duplicates_stream.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Create a dataset of duplicates derived from matching names, email addresses, postal addresses, and phone numbers. The match probability
for each probable duplicate is determined using the fastLink package.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">duplicates_stream</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">duplicates_append_data</span><span class="op">(</span></span>
<span>  <span class="va">data</span>,</span>
<span>  features <span class="op">=</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span>`Current membership` <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">memb_level</span><span class="op">)</span>, `Last login date` <span class="op">=</span></span>
<span>    <span class="va">last_login_dt</span>, `Last activity date` <span class="op">=</span> <span class="va">last_activity_dt</span>, `Last update date` <span class="op">=</span></span>
<span>    <span class="va">last_update_dt</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">duplicates_suppress_related</span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">duplicates_exact_match</span><span class="op">(</span><span class="va">data</span>, <span class="va">match_cols</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>...</dt>
<dd><p>Arguments passed on to <code><a href="https://bamorg-my.sharepoint.com/personal/ssyzygy_bam_org/Documents/documentation/tessilake/reference/read_tessi.html" class="external-link">tessilake::read_tessi</a></code></p><dl><dt><code>freshness</code></dt>
<dd><p>the returned data will be at least this fresh</p></dd>

    <dt><code>incremental</code></dt>
<dd><p>whether or not to load data incrementally, default is <code>TRUE</code></p></dd>

  
</dl></dd>


<dt>data</dt>
<dd><p>data.table to deduplicate</p></dd>


<dt>features</dt>
<dd><p>sorted, named list of expressions to use for selecting which customer
to keep. Note: this is not ready to be exposed; at the moment the appended data is very limited.</p></dd>


<dt>match_cols</dt>
<dd><p>columns to match on</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>data.table of duplicates</p>


<p>data.table</p>


<p>data.table of matching customers with columns <code>customer_no</code> and <code>i.customer_no</code></p>



<p>data.table of data for deduplication</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    
<div class="section">
<h3 id="deduplication-using-fastlink">Deduplication using fastLink<a class="anchor" aria-label="anchor" href="#deduplication-using-fastlink"></a></h3>


<p>This system is based on the fastLink package, a "Fast Probabilistic Record Linkage" library developed by
<a href="https://github.com/kosukeimai/fastLink" class="external-link">Ted Enamorado, Ben Fifield, and Kosuke Imai</a>.</p>
<p>fastLink is designed to find matches between two datasets across multiple variables. It was designed for linking together political/social science datasets.
For deduplication, <code>duplicates_stream</code> compares the data against itself. Links will either be trivial \((A=A)\) or they will be duplicates.</p>
<p>fastLink identifies matches in a way that is sensitive to the structure of the data it is given: it assigns to each match pattern a probability that it is a match.
A match pattern is a unique way that the variables match or don’t match: for example, two records that match on first name, partially match on last name, one is missing
data for email, etc. The algorithm tabulates counts of every occurring combination of match / partial-match / non-match / missing data across every variable for every
combination of two records. It then uses a Bayesian expectation-maximization algorithm to determine the probability that each combination of matches / non-matches / etc.
identifies a proper match, using the overall expected match rate as a prior. Then, given a probability threshold, it outputs the identified matches.</p>
<p><code>duplicates_stream</code> is using this system as-is with some updates for Tessi-specific deduplication:</p><ul><li><p>it pulls multiple rows of data per customer from Tessitura in order to find hidden matches</p></li>
<li><p>it cleans the data, removing missing/incomplete info and also suppresses certain data that produces many false positives (school addresses and @bam.org emails)</p></li>
<li><p>it is trained based on successfully-merged records in the database</p></li>
<li><p>it uses blocking on first name, and a second pass of simple email address matching in order to reduce the overall computation time and catch more duplicates</p></li>
<li><p>it caches datasets to disk to reduce memory load</p></li>
<li><p>it provides reporting that includes the match pattern and posterior probability for each pair</p></li>
</ul></div>

    </div>
    <div class="section level2">
    <h2 id="functions">Functions<a class="anchor" aria-label="anchor" href="#functions"></a></h2>
    
<ul><li><p><code>duplicates_append_data()</code>: Chooses which of each duplicate pair to keep or delete based
on appended data and return the reason for the choice.</p></li>
<li><p><code>duplicates_suppress_related()</code>: Suppress duplicates that are related by household
or that have a relationships (in Tessi-speak: an association) with each other.</p></li>
<li><p><code>duplicates_exact_match()</code>: Returns a minimal (in the sense of each duplicate pairing is limited to the two
closest customer numbers in a duplicate cluster, and each pair is listed only
onc) set of customer pairs matching exactly on <code>match_cols</code>.</p></li>
<li><p><code>duplicates_data()</code>: Load data for duplicates_stream</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="note">Note<a class="anchor" aria-label="anchor" href="#note"></a></h2>
    <p>depends on <a href="address_stream.html">address_stream</a></p>
    </div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Sky Syzygy.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  <script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: false });
  mermaid.run({
    querySelector: '.mermaid code',
  });

  jQuery("pre.mermaid code").on("click", (e) => jQuery(e.currentTarget).toggleClass("svg-modal"))
</script></body></html>

